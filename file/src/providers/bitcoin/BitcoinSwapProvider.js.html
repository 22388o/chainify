<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/providers/bitcoin/BitcoinSwapProvider.js | chainabstractionlayer</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Address.js~Address.html">Address</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Provider.js~Provider.html">Provider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DsnParser">DsnParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureBuffer">ensureBuffer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hash160">hash160</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padHexStart">padHexStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ripemd160">ripemd160</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha256">sha256</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DuplicateProviderError">DuplicateProviderError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-InvalidProviderError">InvalidProviderError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-InvalidProviderResponseError">InvalidProviderResponseError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NoProviderError">NoProviderError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ProviderNotFoundError">ProviderNotFoundError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-StandardError">StandardError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UnimplementedMethodError">UnimplementedMethodError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UnsupportedMethodError">UnsupportedMethodError</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#providers">providers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/ApiProvider.js~ApiProvider.html">ApiProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/JsonRpcProvider.js~JsonRpcProvider.html">JsonRpcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/LedgerProvider.js~LedgerProvider.html">LedgerProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/RpcError.js~RpcError.html">RpcError</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#providers-bitcoin">providers/bitcoin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/bitcoin/BitcoinBlockchainAPIProvider.js~BitcoinBlockchainAPIProvider.html">BitcoinBlockchainAPIProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/bitcoin/BitcoinLedgerProvider.js~BitcoinLedgerProvider.html">BitcoinLedgerProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/bitcoin/BitcoinRPCProvider.js~BitcoinRPCProvider.html">BitcoinRPCProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/bitcoin/BitcoinSwapProvider.js~BitcoinSwapProvider.html">BitcoinSwapProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addressToPubKeyHash">addressToPubKeyHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-compressPubKey">compressPubKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pubKeyHashToAddress">pubKeyHashToAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pubKeyToAddress">pubKeyToAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-reverseBuffer">reverseBuffer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#providers-ethereum">providers/ethereum</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/ethereum/EthereumLedgerProvider.js~EthereumLedgerProvider.html">EthereumLedgerProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/ethereum/EthereumMetaMaskProvider.js~EthereumMetaMaskProvider.html">EthereumMetaMaskProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/ethereum/EthereumRPCProvider.js~EthereumRPCProvider.html">EthereumRPCProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/providers/ethereum/EthereumSwapProvider.js~EthereumSwapProvider.html">EthereumSwapProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureHexEthFormat">ensureHexEthFormat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureHexStandardFormat">ensureHexStandardFormat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatEthResponse">formatEthResponse</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/providers/bitcoin/BitcoinSwapProvider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Provider from &apos;../../Provider&apos;
import { addressToPubKeyHash, compressPubKey, pubKeyToAddress, reverseBuffer } from &apos;./BitcoinUtil&apos;
import { sha256, padHexStart } from &apos;../../crypto&apos;
import networks from &apos;../../networks&apos;

export default class BitcoinSwapProvider extends Provider {
  // TODO: have a generate InitSwap and generate RecipSwap
  //   InitSwap should use checkSequenceVerify instead of checkLockTimeVerify

  constructor (chain = { network: networks.bitcoin }) {
    super()
    this._network = chain.network
  }

  createSwapScript (recipientAddress, refundAddress, secretHash, expiration) {
    let expirationHex = Buffer.from(padHexStart(expiration.toString(16)), &apos;hex&apos;).reverse()

    expirationHex = expirationHex.slice(0, Math.min(expirationHex.length, 5))
    expirationHex.writeUInt8(0, expirationHex.length - 1)

    const recipientPubKeyHash = addressToPubKeyHash(recipientAddress)
    const refundPubKeyHash = addressToPubKeyHash(refundAddress)
    const expirationPushDataOpcode = padHexStart(expirationHex.length.toString(16))
    const expirationHexEncoded = expirationHex.toString(&apos;hex&apos;)

    return [
      &apos;76&apos;, &apos;a9&apos;, // OP_DUP OP_HASH160
      &apos;72&apos;, // OP_2SWAP
      &apos;63&apos;, // OP_IF
      &apos;a8&apos;, // OP_SHA256
      &apos;20&apos;, secretHash, // OP_PUSHDATA(20) {secretHash}
      &apos;88&apos;, // OP_EQUALVERIFY
      &apos;14&apos;, recipientPubKeyHash, // OP_PUSHDATA(20) {recipientPubKeyHash}
      &apos;67&apos;, // OP_ELSE
      expirationPushDataOpcode, // OP_PUSHDATA({expirationHexLength})
      expirationHexEncoded, // {expirationHexEncoded}
      &apos;b1&apos;, // OP_CHECKLOCKTIMEVERIFY
      &apos;6d&apos;, // OP_2DROP
      &apos;14&apos;, refundPubKeyHash, // OP_PUSHDATA(20) {refundPubKeyHash}
      &apos;68&apos;, // OP_ENDIF
      &apos;88&apos;, &apos;ac&apos; // OP_EQUALVERIFY OP_CHECKSIG
    ].join(&apos;&apos;)
  }

  async initiateSwap (value, recipientAddress, refundAddress, secretHash, expiration) {
    const script = this.createSwapScript(recipientAddress, refundAddress, secretHash, expiration)
    const scriptPubKey = padHexStart(script)
    const p2shAddress = pubKeyToAddress(scriptPubKey, this._network.name, &apos;scriptHash&apos;)
    return this.getMethod(&apos;sendTransaction&apos;)(p2shAddress, value, script)
  }

  async claimSwap (initiationTxHash, recipientAddress, refundAddress, secret, expiration) {
    const secretHash = sha256(secret)
    const script = this.createSwapScript(recipientAddress, refundAddress, secretHash, expiration)
    const scriptPubKey = padHexStart(script)
    const p2shAddress = pubKeyToAddress(scriptPubKey, this._network.name, &apos;scriptHash&apos;)
    const sendScript = this.getMethod(&apos;createScript&apos;)(p2shAddress)

    const initiationTxRaw = await this.getMethod(&apos;getRawTransactionByHash&apos;)(initiationTxHash)
    const initiationTx = await this.getMethod(&apos;splitTransaction&apos;)(initiationTxRaw, true)
    const voutIndex = initiationTx.outputs.findIndex((output) =&gt; output.script.toString(&apos;hex&apos;) === sendScript)

    const txHashLE = Buffer.from(initiationTxHash, &apos;hex&apos;).reverse().toString(&apos;hex&apos;) // TX HASH IN LITTLE ENDIAN
    const newTxInput = this.generateSigTxInput(txHashLE, voutIndex, script)
    const newTx = this.generateRawTx(initiationTx, voutIndex, recipientAddress, newTxInput)
    const splitNewTx = await this.getMethod(&apos;splitTransaction&apos;)(newTx, true)
    const outputScriptObj = await this.getMethod(&apos;serializeTransactionOutputs&apos;)(splitNewTx)
    const outputScript = outputScriptObj.toString(&apos;hex&apos;)

    const signature = await this.getMethod(&apos;signP2SHTransaction&apos;)(
      [[initiationTx, 0, script]],
      [`44&apos;/1&apos;/0&apos;/0/0`],
      outputScript
    )

    const pubKeyInfo = await this.getMethod(&apos;getPubKey&apos;)(recipientAddress)
    const pubKey = compressPubKey(pubKeyInfo.publicKey)
    const spendSwap = this._spendSwap(signature[0], pubKey, true, secret)
    const spendSwapInput = this._spendSwapInput(spendSwap, script)
    const rawClaimTxInput = this.generateRawTxInput(txHashLE, spendSwapInput)
    const rawClaimTx = this.generateRawTx(initiationTx, voutIndex, recipientAddress, rawClaimTxInput)

    return this.getMethod(&apos;sendRawTransaction&apos;)(rawClaimTx)
  }

  _spendSwap (signature, pubKey, isRedeem, secret) {
    const redeemEncoded = isRedeem ? &apos;51&apos; : &apos;00&apos; // OP_1 : OP_0
    const encodedSecret = isRedeem
      ? [
        padHexStart((secret.length / 2).toString(16)), // OP_PUSHDATA({secretLength})
        secret
      ]
      : [&apos;00&apos;] // OP_0

    const signatureEncoded = signature + &apos;01&apos;
    const signaturePushDataOpcode = padHexStart((signatureEncoded.length / 2).toString(16))
    const pubKeyPushDataOpcode = padHexStart((pubKey.length / 2).toString(16))

    const bytecode = [
      signaturePushDataOpcode,
      signatureEncoded,
      ...encodedSecret,
      redeemEncoded,
      pubKeyPushDataOpcode,
      pubKey
    ]

    return bytecode.join(&apos;&apos;)
  }

  _spendSwapInput (spendSwapBytecode, voutScript) {
    const bytecode = [
      spendSwapBytecode,
      &apos;4c&apos;,
      padHexStart((voutScript.length / 2).toString(16)),
      voutScript
    ]

    return bytecode.join(&apos;&apos;)
  }

  getRedeemSwapData (secret, pubKey, signature) {
    return this._spendSwap(signature, pubKey, true, secret)
  }

  getRefundSwapData (pubKey, signature) {
    return this._spendSwap(signature, pubKey, false)
  }

  async getSwapTransaction (blockNumber, recipientAddress, refundAddress, secretHash, expiration) {
    const data = this.createSwapScript(recipientAddress, refundAddress, secretHash, expiration)
    const scriptPubKey = padHexStart(data)
    const receivingAddress = pubKeyToAddress(scriptPubKey, this._network.name, &apos;scriptHash&apos;)
    const sendScript = this.getMethod(&apos;createScript&apos;)(receivingAddress)

    const block = await this.getMethod(&apos;getBlockByNumber&apos;)(blockNumber, true)
    const transactions = block.transactions
    const txs = await Promise.all(transactions.map(async transaction =&gt; {
      return this.getMethod(&apos;decodeRawTransaction&apos;)(transaction)
    }))
    const swapTx = txs
      .map(transaction =&gt; transaction._raw.data)
      .map(transaction =&gt; transaction.vout
        .map(vout =&gt; { return { txid: transaction.txid, scriptPubKey: vout.scriptPubKey } }))
      .reduce((acc, val) =&gt; acc.concat(val), [])
      .find(txKeys =&gt; txKeys.scriptPubKey.hex === sendScript)
    return swapTx ? swapTx.txid : null
  }

  async getSwapConfirmTransaction (blockNumber, initiationTxHash, secretHash) {
    const block = await this.getMethod(&apos;getBlockByNumber&apos;)(blockNumber, true)
    const transactions = block.transactions
    const txs = await Promise.all(transactions.map(async transaction =&gt; {
      return this.getMethod(&apos;decodeRawTransaction&apos;)(transaction)
    }))
    const swapTx = txs
      .reduce((acc, val) =&gt; acc.concat({ hash: val.hash, vin: val._raw.data.vin }), [])
      .map(val =&gt; val.vin.map(vin =&gt; { return { hash: val.hash, vin: vin } }))
      .flat()
      .find(tx =&gt; tx.vin.txid === initiationTxHash)
    return swapTx ? swapTx.hash : null
  }

  async getSecret (claimTxHash) {
    const claimTxRaw = await this.getMethod(&apos;getRawTransactionByHash&apos;)(claimTxHash)
    const claimTx = await this.getMethod(&apos;decodeRawTransaction&apos;)(claimTxRaw)
    const script = Buffer.from(claimTx._raw.data.vin[0].scriptSig.hex, &apos;hex&apos;)
    const sigLength = script[0]
    const secretLength = script.slice(sigLength + 1)[0]
    return script.slice(sigLength + 2, sigLength + secretLength + 2).toString(&apos;hex&apos;)
  }

  generateSigTxInput (txHashLE, voutIndex, script) {
    const inputTxOutput = padHexStart(voutIndex.toString(16), 8)
    const scriptLength = padHexStart((script.length / 2).toString(16))

    return [
      &apos;01&apos;, // NUM INPUTS
      txHashLE,
      inputTxOutput, // INPUT TRANSACTION OUTPUT
      scriptLength,
      script,
      &apos;ffffffff&apos; // SEQUENCE
    ].join(&apos;&apos;)
  }

  generateRawTxInput (txHashLE, script) {
    const scriptLength = padHexStart((script.length / 2).toString(16))

    return [
      &apos;01&apos;, // NUM INPUTS
      txHashLE,
      &apos;00000000&apos;,
      scriptLength,
      script,
      &apos;ffffffff&apos; // SEQUENCE
    ].join(&apos;&apos;)
  }

  generateRawTx (initiationTx, voutIndex, address, input) {
    const output = initiationTx.outputs[voutIndex]
    const value = parseInt(reverseBuffer(output.amount).toString(&apos;hex&apos;), 16)
    const fee = this.getMethod(&apos;calculateFee&apos;)(1, 1, 3)
    const amount = value - fee
    const amountLE = Buffer.from(padHexStart(amount.toString(16), 16), &apos;hex&apos;).reverse().toString(&apos;hex&apos;) // amount in little endian
    const pubKeyHash = addressToPubKeyHash(address)

    return [
      &apos;01000000&apos;, // VERSION

      input,

      &apos;01&apos;, // NUM OUTPUTS
      amountLE,
      &apos;19&apos;, // data size to be pushed
      &apos;76&apos;, // OP_DUP
      &apos;a9&apos;, // OP_HASH160
      &apos;14&apos;, // data size to be pushed
      pubKeyHash, // &lt;PUB_KEY_HASH&gt;
      &apos;88&apos;, // OP_EQUALVERIFY
      &apos;ac&apos;, // OP_CHECKSIG

      &apos;00000000&apos; // OUTPUTS
    ].join(&apos;&apos;)
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
